{% extends "base.html" %}

{% block title %}データ表示 - 不動産事業計画{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>40年間の財務データ</h1>
        <p>収入、支出、減価償却、キャッシュフローなどの40年間の推移を表示します。</p>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" onclick="showTable('all')">全項目</button>
            <button type="button" class="btn btn-outline-success" onclick="showTable('income')">収入</button>
            <button type="button" class="btn btn-outline-danger" onclick="showTable('expenses')">支出</button>
            <button type="button" class="btn btn-outline-warning" onclick="showTable('depreciation')">減価償却</button>
            <button type="button" class="btn btn-outline-info" onclick="showTable('cashflow')">キャッシュフロー</button>
        </div>
        <button class="btn btn-primary ms-3" onclick="recalculate()">再計算</button>
        <button class="btn btn-success ms-2" onclick="exportData()">CSVエクスポート</button>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="table-responsive" style="max-height: 70vh;">
            <table class="table table-striped table-hover" id="dataTable">
                <thead class="table-dark sticky-header">
                    <tr>
                        <th>年</th>
                        <th class="number-format">収入</th>
                        <th class="number-format">支出</th>
                        <th class="number-format">減価償却</th>
                        <th class="number-format">年間CF</th>
                        <th class="number-format">累積CF</th>
                        <th class="number-format">ローン残高</th>
                        <th class="number-format">APR</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    {% if data %}
                        {% for row in data %}
                        <tr>
                            <td>{{ row.year }}年目</td>
                            <td class="number-format income-col">{{ "{:,.0f}".format(row.income) }}</td>
                            <td class="number-format expenses-col">{{ "{:,.0f}".format(row.expenses) }}</td>
                            <td class="number-format depreciation-col">{{ "{:,.0f}".format(row.depreciation) }}</td>
                            <td class="number-format cashflow-col 
                                {% if row.cashflow > 0 %}text-success{% elif row.cashflow < 0 %}text-danger{% endif %}">
                                {{ "{:,.0f}".format(row.cashflow) }}
                            </td>
                            <td class="number-format cashflow-col 
                                {% if row.cumulative_cashflow > 0 %}text-success{% elif row.cumulative_cashflow < 0 %}text-danger{% endif %}">
                                {{ "{:,.0f}".format(row.cumulative_cashflow) }}
                            </td>
                            <td class="number-format cashflow-col">{{ "{:,.0f}".format(row.loan_balance) }}</td>
                            <td class="number-format cashflow-col">{{ "{:.2%}".format(row.apr) }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center">データがありません。設定を確認し、再計算してください。</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if data %}
<div class="row mt-4">
    <div class="col-12">
        <h4>サマリー</h4>
        <div class="row">
            <div class="col-md-3">
                <div class="card text-bg-primary">
                    <div class="card-body">
                        <h5 class="card-title">総収入</h5>
                        <p class="card-text h4">{{ "{:,.0f}".format(data|sum(attribute='income')) }}円</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-bg-danger">
                    <div class="card-body">
                        <h5 class="card-title">総支出</h5>
                        <p class="card-text h4">{{ "{:,.0f}".format(data|sum(attribute='expenses')) }}円</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-bg-warning">
                    <div class="card-body">
                        <h5 class="card-title">総減価償却</h5>
                        <p class="card-text h4">{{ "{:,.0f}".format(data|sum(attribute='depreciation')) }}円</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-bg-{% if data[-1].cumulative_cashflow > 0 %}success{% else %}danger{% endif %}">
                    <div class="card-body">
                        <h5 class="card-title">最終累積CF</h5>
                        <p class="card-text h4">{{ "{:,.0f}".format(data[-1].cumulative_cashflow) }}円</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
let currentData = {{ data | tojson }};

function showTable(type) {
    const table = document.getElementById('dataTable');
    const headers = table.querySelectorAll('th');
    const rows = table.querySelectorAll('tbody tr');
    
    // すべての列を表示
    headers.forEach(h => h.style.display = '');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => cell.style.display = '');
    });
    
    // 特定の列のみ表示
    if (type !== 'all') {
        const visibleColumns = [0]; // 年は常に表示
        
        switch(type) {
            case 'income':
                visibleColumns.push(1);
                break;
            case 'expenses':
                visibleColumns.push(2);
                break;
            case 'depreciation':
                visibleColumns.push(3);
                break;
            case 'cashflow':
                visibleColumns.push(4, 5, 6, 7);
                break;
        }
        
        headers.forEach((h, i) => {
            if (!visibleColumns.includes(i)) {
                h.style.display = 'none';
            }
        });
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            cells.forEach((cell, i) => {
                if (!visibleColumns.includes(i)) {
                    cell.style.display = 'none';
                }
            });
        });
    }
    
    // ボタンのアクティブ状態を更新
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

function recalculate() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '計算中...';
    
    fetch('/api/calculate')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentData = data.data;
                updateTable(data.data);
                alert('再計算が完了しました。');
            } else {
                alert('計算エラー: ' + data.error);
            }
        })
        .catch(error => {
            alert('エラーが発生しました: ' + error);
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = '再計算';
        });
}

function updateTable(data) {
    const tbody = document.getElementById('dataTableBody');
    tbody.innerHTML = '';
    
    data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.year}年目</td>
            <td class="number-format income-col">${formatNumber(row.income)}</td>
            <td class="number-format expenses-col">${formatNumber(row.expenses)}</td>
            <td class="number-format depreciation-col">${formatNumber(row.depreciation)}</td>
            <td class="number-format cashflow-col ${row.cashflow > 0 ? 'text-success' : row.cashflow < 0 ? 'text-danger' : ''}">${formatNumber(row.cashflow)}</td>
            <td class="number-format cashflow-col ${row.cumulative_cashflow > 0 ? 'text-success' : row.cumulative_cashflow < 0 ? 'text-danger' : ''}">${formatNumber(row.cumulative_cashflow)}</td>
            <td class="number-format cashflow-col">${formatNumber(row.loan_balance)}</td>
            <td class="number-format cashflow-col">${formatPercent(row.apr)}</td>
        `;
        tbody.appendChild(tr);
    });
}

function exportData() {
    if (!currentData || currentData.length === 0) {
        alert('エクスポートするデータがありません。');
        return;
    }
    
    let csv = '年,収入,支出,減価償却,年間キャッシュフロー,累積キャッシュフロー,ローン残高,APR\n';
    
    currentData.forEach(row => {
        csv += `${row.year},${row.income},${row.expenses},${row.depreciation},${row.cashflow},${row.cumulative_cashflow},${row.loan_balance},${row.apr}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'real_estate_financial_data.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// 初期表示時は全項目を表示
document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('.btn-group button').classList.add('active');
});
</script>
{% endblock %}
